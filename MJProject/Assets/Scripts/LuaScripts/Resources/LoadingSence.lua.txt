LoadingSence = {}
local FairyGUI = require "FairyGUI"
local util = require "xlua.util"
local function AsyncYieldReturn(to_yield, cb)
    self:YieldAndCallback(to_yield, cb)
end
local yield_return = util.async_to_sync(AsyncYieldReturn)
local WeChatPlatform = CS.Platform.Instance
local rapidjson = require "rapidjson"

local dataPath = ""
--[[
local HotFixUrl = "http://api.cloudbm.wang/game/download"
local Md5Url = "http://api.cloudbm.wang/game/hotupdate"
local httpUrlToken = "http://api.cloudbm.wang/auth/jwt"
--]]
local HotFixUrl = "http://testapi.cloudbm.wang/game/download"
local Md5Url = "http://testapi.cloudbm.wang/game/hotupdate"
local httpUrlToken = "http://testapi.cloudbm.wang/auth/jwt"

local httpAppID = "snve1zlao934hhh323"
local httpAppSecret = "fiejfAJG%139*&sdfjNMJQA"

local httpToken = ""

local currentMd5 = "9af6ad141df0f43fa4222acfa69e9dcb"--版本md5
local isReloadData = false

local localMd5 = ""
local serveMd5 = ""

local loadingUI = nil
local loadingBar = nil
local downloadProgress = nil
local downloadSize = 0
local currentWWW = nil
local loadingBarProgress = 0

local www = nil

function awake()
	-- body
	UIConfig.defaultFont = "MJFont"
	loadingUI = CS.UnityEngine.GameObject.Find("UIPanel"):GetComponent("UIPanel").ui
	loadingUI:GetChild("InformNoHorn").visible = false
	loadingBar = loadingUI:GetChild("LoadingBar")
	loadingBar.value = 0
	loadingBar:GetChild("DownloadSpeed").visible = false
	loadingBar:GetChild("n5").visible = false
	downloadProgress = loadingBar:GetChild("Schedule")
	--downloadProgress.visible = false
	CS.UnityEngine.Application.targetFrameRate = 30
	loadingBarProgress = 0
end

function start()
	-- body
	dataPath = CS.UnityEngine.Application.persistentDataPath.."/"
	if not Player then
		--local md5
		local hotfixMd5 = io.open(dataPath.."hotfixMd5.txt")
		if not hotfixMd5 then
			--localMd5，数据里没有md5
			local mFile = io.open(dataPath.."hotfixMd5.txt" ,"w")
	        mFile:write(currentMd5)
	        mFile:close()
	        localMd5 = currentMd5
		else
			localMd5 = hotfixMd5:read "*a"
	        hotfixMd5:close()
		end
		--server md5
		LoadingSence.GetServerMd5()
	else
		LoadingSence.BeginGame()
	end
end

function update( ... )
	-- body
	if isReloadData == true then
		if CS.AssetsHandle.progress >= 1 then
			isReloadData = false
			LoadingSence.BeginGame()
		end
	end

	if www then
		LoadingSence.SetLoadingBar(www.progress)
		downloadProgress.text = tostring(math.ceil(www.bytesDownloaded * www.progress/1024)).."kb/"..tostring(math.ceil(www.bytesDownloaded/1024)).."kb"
		--CS.UnityEngine.Debug.LogWarning(www.bytesDownloaded)
	end
	--[[
	if isReloadData and isReloadData == true then
		LoadingSence.BeginGame()
		isReloadData = false
	else
		LoadingSence.SetLoadingBar(CS.AssetsHandle.progress)
	end

	if currentWWW and currentWWW.isDone == false then
		LoadingSence.SetLoadingBar(loadingBarProgress * 100)
		--downloadProgress.text = string.format("%.1f", downloadSize * currentWWW.progress /1024).."kb/"..string.format("%.1f",downloadSize/1024).."kb"
	end
	--]]
end

function LoadingSence.SetLoadingBar(progress)
	-- body
	local progessInt = math.ceil(progress * 100)
	loadingBar.value = progessInt
end

function LoadingSence.DownloadData( ... )
	-- body
	local folder = CS.System.IO.FileInfo(CS.UnityEngine.Application.persistentDataPath.."/MyAssets.upk")
	if not folder.Exists then
		isReloadData = true
		local co = coroutine.create(function()
			local header = {}
			header.jwt = httpToken
			header["User-Agent"] = "BH-MJProject1.0.2.0916"
			www = CS.UnityEngine.WWW(HotFixUrl, rapidjson.encode(header.jwt), header)
			--[[
			while currentWWW.isDone == false do
				loadingBarProgress = currentWWW.progress
				--LoadingSence.SetLoadingBar(currentWWW.progress * 100)
				yield_return(1)
			end
			--]]
			--downloadSize = www.bytesDownloaded
			yield_return(www)
			if not www.error then
				local path = CS.UnityEngine.Application.persistentDataPath
				if not CS.System.IO.Directory:Exists(path)then
					CS.System.IO.Directory.CreateDirectory(path)
				end
				--[[
				CS.AssetsHandle.dataFinish = function (progress)
					-- body
					--LoadingSence.SetLoadingBar(progress * 100)
					loadingBarProgress = progress
					if progress == 1 then
						CS.AssetsHandle.dataFinish = nil
						isReloadData = true
					end
				end
				--]]
				CS.AssetsHandle.CreateNewAsset(www.bytes,path.."/MyAssets.upk")
				local mFile = io.open(dataPath.."hotfixMd5.txt" ,"w")
		        mFile:write(serveMd5)
		        mFile:close()
		        CS.AssetsHandle.UnPackAssetFolder(path.."/MyAssets.upk",path.."/")
		        --currentWWW = nil
		        --loadingBar.value = 0
			else
				CS.UnityEngine.Debug.LogWarning('error:'..www.error)
			end
	    end)
	    coroutine.resume(co)
	else
		CS.UnityEngine.Debug.LogWarning("path error")
		os.remove(dataPath.."MyAssets.upk")
	end
end

function LoadingSence.CopyAndroidRes()
	-- body
	--android load
	local needCopy = true
	local folder = CS.System.IO.FileInfo(CS.UnityEngine.Application.persistentDataPath.."/MyAssets.upk")
	if not folder.Exists then
		isReloadData = true
		local co = coroutine.create(function()
			local www = CS.UnityEngine.WWW(CS.LuaCommon.resultPath.."MyAssets.upk")
			yield_return(www)
			if not www.error then
				local path = CS.UnityEngine.Application.persistentDataPath
				if not CS.System.IO.Directory:Exists(path)then
					CS.System.IO.Directory.CreateDirectory(path)
				end
				--[[
				CS.AssetsHandle.dataFinish = function (progress)
					-- body
					--LoadingSence.SetLoadingBar(progress * 100)
					loadingBarProgress = progress
					if progress == 1 then
						CS.AssetsHandle.dataFinish = nil
						isReloadData = true
					end
				end
				--]]
				CS.AssetsHandle.CreateNewAsset(www.bytes,path.."/MyAssets.upk")
		        CS.AssetsHandle.UnPackAssetFolder(path.."/MyAssets.upk",path.."/")
		        --[[
				local fs = CS.System.IO.FileStream(path.."/Asset.upk", CS.System.IO.FileMode.Create)
				fs:Write(www.bytes,0,1024)
				fs:Flush()
		        fs:Close()
		        fs:Dispose()
		        --]]
			else
				CS.UnityEngine.Debug.LogWarning('error:'..www.error)
			end
	    end)
	    coroutine.resume(co)
	else
		CS.UnityEngine.Debug.LogWarning("path error")
		needCopy = false
	end
    return needCopy
end

function LoadingSence.BeginGame( ... )
	-- body
	local LoadingCT = require "LoadingCT"
	LoadingCT.self = self
	LoadingCT.ToSence("FairyMainUI")
end

function LoadingSence.GetServerMd5( ... )
	-- body
	local httpTokenFile = io.open(dataPath.."httpToken.txt")
	httpToken = ""
	if not httpTokenFile then
		LoadingSence.GetHttpToken()
	else
		httpToken = httpTokenFile:read "*a"
        httpTokenFile:close()
		if httpToken ~= "" then
	        LoadingSence.RequestServerMd5()
	    else
	    	LoadingSence.GetHttpToken()
		end
	end
end

function LoadingSence.RandomString( ... )
	-- body
	math.randomseed(os.time())
	local outPut = ""
	for i=1,7 do
		local index = math.random(0,61)
		if index < 10 then
			outPut = outPut..tostring(index)
		elseif index >= 10 and index <= 35 then
			outPut = outPut..string.char(index + 55)
		elseif index >= 36 and index <= 61 then
			outPut = outPut..string.char(index + 61)
		end
	end
	return outPut
end

function LoadingSence.GetHttpToken()
	-- body
	local time = os.time()
	local nonce = LoadingSence.RandomString()
	local sign = WeChatPlatform:GetMd5String("app_id="..httpAppID.."&nonce="..nonce.."&time="..tostring(time).."&"..httpAppSecret)
	local header = {}
	header["User-Agent"] = "BH-MJProject1.0.2.0916"

	local co = coroutine.create(function()
		local www = CS.UnityEngine.WWW(httpUrlToken.."?app_id="..httpAppID.."&time="..tostring(time).."&nonce="..nonce.."&sign="..sign,rapidjson.encode(header["User-Agent"]),header)
		yield_return(www)
		if not www.error then
			local jsonData = rapidjson.decode(www.text)
			if jsonData.code == 0 then
				httpToken = jsonData.data.jwt
				local path = CS.UnityEngine.Application.persistentDataPath.."/"
				local mFile = io.open(path.."httpToken.txt" ,"w")
		        mFile:write(httpToken)
		        mFile:close()
		        LoadingSence.RequestServerMd5()
			else
				print("httpException")
			end
		else
			CS.UnityEngine.Debug.LogWarning('error:'..www.error)
		end
    end)
    coroutine.resume(co)
end

function LoadingSence.RequestServerMd5( ... )
	-- body
	local co = coroutine.create(function()
		local header = {}
		header.jwt = httpToken
		header["User-Agent"] = "BH-MJProject1.0.2.0916"
		local www = CS.UnityEngine.WWW(Md5Url, rapidjson.encode(header.jwt), header)
		yield_return(www)
		if not www.error then
			print(www.text)
			local jsonData = rapidjson.decode(www.text)
			if jsonData.code == 0 then
				serveMd5 = jsonData.data.md5
				if serveMd5 == localMd5 then
					if LoadingSence.CopyAndroidRes() == false then
						LoadingSence.BeginGame()
					end
				else
					print("jxydelete")
					os.remove(dataPath.."hotfixMd5.txt")
					os.remove(dataPath.."MyAssets.upk")
			        LoadingSence.DownloadData()
				end
			elseif jsonData.code == 200101 then
				LoadingSence.GetHttpToken()
			else
			end
		else
			CS.UnityEngine.Debug.LogWarning('error:'..www.error)
		end
    end)
    coroutine.resume(co)
end

return LoadingSence