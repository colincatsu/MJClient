MainUICT = {}
local Enum = require "Enum"
local Player = require "Player"
Player.self = self
local ClickEvent = require "ClickEvent"
ClickEvent.self = self
local Network = require "Network"
local FLibEvent = require "FLibEvent"
local FairyGUI = require "FairyGUI"
local AssetManager = require "AssetManager"
local AudioPlayer = require "AudioPlayer"

local _main_ui_sence = "FairyMainUI"
local _loading_sence = "LoadingSence"
local _play_sence = "PlaySence"

local rapidjson = require "rapidjson"
local util = require "xlua.util"
local function AsyncYieldReturn(to_yield, cb)
    self:YieldAndCallback(to_yield, cb)
end
local yield_return = util.async_to_sync(AsyncYieldReturn)
local httpUrlToken = "http://api.cloudbm.wang/auth/jwt"
local httpUrlServer = "http://api.cloudbm.wang/maintain/server"
--[[
local isOn = false
local _Main_UI 
local _Choose_UI 
local _Player_Message_UI 
local _Other_Message_UI 
local _Store_UI 
local _Creat_Room_UI 
--]]
function awake()
	-- body
	ClickEvent.Awake()
	if CS.LuaCommon.isIos == false then
		CS.UnityEngine.Screen.sleepTimeout = CS.UnityEngine.SleepTimeout.NeverSleep
	end
end

function start()
	-- body
	if not Player._connected then
		Network.Start()
		Network.ConnetServer()
	end
	ClickEvent.uiPanel.ui:GetChild("LoadingBar").visible = false
	if Player._connected then
		if Player.returnMainUI then
			ClickEvent.Start(ClickEvent.panelTable._choose_ui)
		else
			if Player._tosence_name and Player._tosence_name ~= "PlaySence" then
				ClickEvent.Start(ClickEvent.panelTable._main_ui)
			end
		end
	end
	Player.LoadData()
	if Player.hasTestPauseServer == false then
		--MainUICT.TestServerState()
	end
	--[[
	_Main_UI = self.transform:Find("MainUI").gameObject
	local admitButton = _Main_UI.transform:Find("Admit").gameObject
	isOn = admitButton:GetComponent("Toggle").isOn
	_Choose_UI = self.transform:Find("ChooseUI").gameObject
	_Choose_UI:SetActive(false)
	_Player_Message_UI = self.transform:Find("PlayerMessage").gameObject
	_Other_Message_UI = self.transform:Find("OtherMessage").gameObject
	_Store_UI = self.transform:Find("StoreUI").gameObject
	_Creat_Room_UI = self.transform:Find("CreatRoom").gameObject
	--]]

	---[[
	--]]
	--AudioPlayer.PlaySound(AudioPlayer._audio_name.Bgm,true,0.5)
end

function update( ... )
	-- body
	Player.myUpdate()
	--[[
	if Player.self == self then
		local x = Player.GetinvokeFunctionCache()
		if x then
			x()
		end
	end
	print("jxy")
	--]]
end
function MainUICT.TestServerState()
	-- body
	local path = CS.UnityEngine.Application.persistentDataPath.."/"
	local httpTokenFile = io.open(path.."httpToken.txt")
	if not httpTokenFile then
		MainUICT.GetHttpToken()
	else
		Player.httpToken = httpTokenFile:read "*a"
        httpTokenFile:close()
        MainUICT.RequestServerState()
	end

end

function MainUICT.GetHttpToken( ... )
	-- body
	local co = coroutine.create(function()
		local www = CS.UnityEngine.WWW(httpUrlToken)
		yield_return(www)
		if not www.error then
			local jsonData = rapidjson.decode(www.text)
			if jsonData.code == 0 then
				Player.httpToken = jsonData.data.jwt
				Player.LogWarning(jsonData.data.jwt)
				local path = CS.UnityEngine.Application.persistentDataPath.."/"
				local mFile = io.open(path.."httpToken.txt" ,"w")
		        mFile:write(Player.httpToken)
		        mFile:close()
		        MainUICT.RequestServerState()
			else
				Player.LogWarning("httpException")
			end
		else
			CS.UnityEngine.Debug.LogWarning('error:'..www.error)
		end
    end)
    coroutine.resume(co)
end

function MainUICT.RequestServerState( ... )
	-- body
	local co = coroutine.create(function()
		local header = {}
		header.jwt = Player.httpToken
		header["User-Agent"] = "BH-MJProject"..Player.pc_version
		local www = CS.UnityEngine.WWW(httpUrlServer, rapidjson.encode(header.jwt), header)
		yield_return(www)
		if not www.error then
			local jsonData = rapidjson.decode(www.text)
			if jsonData.code == 0 then
				if jsonData.data.is_running == false then
					Player.LogWarning(jsonData.data.tips)
					ClickEvent.ShowSmallWindowByContent(jsonData.data.tips)
				end
				Player.hasTestPauseServer = true
			elseif jsonData.code == 200101 then
				MainUICT.GetHttpToken()
			else
				Player.LogWarning("httpException")
			end
			
		else
			CS.UnityEngine.Debug.LogWarning('error:'..www.error)
		end
    end)
    coroutine.resume(co)
end

return MainUICT
